<!DOCTYPE html>
<html>
<head>
    <title>YORISOI_21</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.0/dist/mindar-image.prod.js"></script>
    <script>
        // 星空コンポーネント (Starry sky component)
        AFRAME.registerComponent('starry-sky', {
            schema: {
                count: {type: 'number', default: 1000},
                radius: {type: 'number', default: 90}
            },
            init: function () {
                const el = this.el;
                const data = this.data;
                
                for (let i = 0; i < data.count; i++) {
                    const star = document.createElement('a-sphere');
                    star.setAttribute('radius', Math.random() * 0.05 + 0.02);
                    star.setAttribute('color', '#FFFFFF');
                    star.setAttribute('material', 'shader: flat; emissive: #FFFFFF; emissiveIntensity: 0.8;');

                    const u = Math.random();
                    const v = Math.random();
                    const theta = 2 * Math.PI * u;
                    const phi = Math.acos(2 * v - 1);
                    const x = data.radius * Math.sin(phi) * Math.cos(theta);
                    const y = data.radius * Math.sin(phi) * Math.sin(theta);
                    const z = data.radius * Math.cos(phi);
                    
                    star.setAttribute('position', `${x} ${y} ${z}`);
                    el.appendChild(star);
                }
            }
        });

        // 雨のコンポーネント (Rain component)
        AFRAME.registerComponent('rain', {
            schema: {
                count: {type: 'number', default: 1500},
                area: {type: 'number', default: 30},
                roomDepth: {type: 'number', default: 6}
            },
            init: function () {
                const el = this.el;
                const data = this.data;
                const area = data.area;
                const roomDepth = data.roomDepth;
              
                for (let i = 0; i < data.count; i++) {
                    const rainDrop = document.createElement('a-box');
                    rainDrop.setAttribute('color', '#ADD8E6');
                    rainDrop.setAttribute('width', 0.01);
                    rainDrop.setAttribute('height', 0.15);
                    rainDrop.setAttribute('depth', 0.01);
                    
                    let x, y, z;

                    do {
                        x = Math.random() * area - area / 2;
                        z = Math.random() * area - area / 2;
                    } while (x > -3 && x < 3 && z > -3 - roomDepth / 2 && z < -3 + roomDepth / 2);
                    y = Math.random() * 10 + 10;
                    
                    rainDrop.setAttribute('position', `${x} ${y} ${z}`);
                    rainDrop.setAttribute('animation__fall', {
                        property: 'position',
                        to: `${x} 0 ${z}`,
                        dur: Math.random() * 1500 + 1500,
                        loop: true,
                        easing: 'linear'
                    });
                    el.appendChild(rainDrop);
                }
            }
        });

        // 時計コンポーネント (Clock component)
        AFRAME.registerComponent('clock', {
            tick: function () {
                const el = this.el;
                const now = new Date();
                const jst_time = now.toLocaleString("ja-JP", {
                    timeZone: "Asia/Tokyo",
                    hour: '2-digit',
                    minute: '2-digit'
                });
                el.setAttribute('value', jst_time);
            }
        });

        // 雨音再生コンポーネント (Rain sound component)
        AFRAME.registerComponent('audio-control', {
            init: function () {
                const audioEl = document.getElementById('rain-audio');
                audioEl.volume = 0.5;
                
                this.el.sceneEl.addEventListener('enter-vr', function () {
                    audioEl.play();
                });
            }
        });

        // インタラクティブなコンポーネント (Interactive components)
        AFRAME.registerComponent('light-switch', {
            init: function () {
                const lightEl = document.getElementById('lamp-light');
                const switchEl = this.el;
                let lightIsOn = true;

                switchEl.addEventListener('click', function () {
                    if (lightIsOn) {
                        lightEl.setAttribute('light', 'intensity', 0);
                        lightIsOn = false;
                    } else {
                        lightEl.setAttribute('light', 'intensity', 1.5);
                        lightIsOn = true;
                    }
                });
            }
        });

        // 雨音スイッチのコンポーネント
        AFRAME.registerComponent('rain-switch', {
            init: function () {
                const audioEl = document.getElementById('rain-audio');
                const switchEl = this.el;
                let isPlaying = true;
                
                switchEl.addEventListener('click', function () {
                    if (isPlaying) {
                        audioEl.pause();
                        isPlaying = false;
                    } else {
                        audioEl.play();
                        isPlaying = true;
                    }
                });
            }
        });

        // ホバーでテキスト表示するコンポーネント
        AFRAME.registerComponent('hover-text', {
            schema: {
                textId: {type: 'string', default: ''}
            },
            init: function () {
                const textEl = document.getElementById(this.data.textId);
                textEl.setAttribute('visible', false);

                this.el.addEventListener('mouseenter', function () {
                    textEl.setAttribute('visible', true);
                });

                this.el.addEventListener('mouseleave', function () {
                    textEl.setAttribute('visible', false);
                });
            }
        });
    </script>
</head>
<body>
    <audio id="rain-audio" src="./KODOKU/rain.mp3" loop></audio>

    <a-scene
        mindar-image="imageTargetSrc: https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.0/examples/image-tracking/assets/card-example/card.mind"
        audio-control>

        <a-entity mindar-image-target="targetIndex: 0">
            <a-entity position="0 0 0" rotation="0 0 0" scale="1 1 1">
                <a-light id="room-light" type="ambient" color="#fff" intensity="0.3"></a-light>
                <a-light id="lamp-light" type="point" color="#ffc" intensity="1.5" position="-1.5 0.1 -4"></a-light>
                
                <a-sky color="#223" material="shader: flat;"></a-sky>
                <a-entity starry-sky="count: 1000; radius: 90;"></a-entity>
                <a-entity rain="count: 1500; area: 30; roomDepth: 6;"></a-entity>

                <a-box position="0 0 -3" width="6" height="0.1" depth="6" color="#C2B7A1"></a-box>
                <a-box position="0 3 -3" width="6" height="0.1" depth="6" material="color: #ADD8E6; opacity: 0.3; transparent: true;"></a-box>
                <a-box position="0 1.5 -6" width="6" height="3" depth="0.1" color="#A09585" material="side: back;"></a-box>
                <a-box position="-3 1.5 -3" width="0.1" height="3" depth="6" color="#A09585" material="side: back;"></a-box>
                <a-box position="3 1.5 -3" width="0.1" height="3" depth="6" color="#A09585" material="side: back;"></a-box>
                <a-box position="0 1.5 0" width="6" height="3" depth="0.1" color="#A09585" material="side: back;"></a-box>
                
                <a-box position="0 1.5 -5.9" width="3" height="2" depth="0.1" material="opacity:0.2; color: #ADD8E6"></a-box>
                
                <a-box id="table" position="-0.5 0.2 -4" width="2" height="0.3" depth="2.5" color="#8b4513" grabbable></a-box>
                <a-box id="magazine-holder" position="-0.5 0.4 -4.8" width="2" height="0.2" depth="0.5" color="#c0c0c0" grabbable></a-box>
                <a-sphere id="lamp" position="-1.5 0.1 -4" radius="0.15" color="#FFFF00" hover-text="textId: thank-you-text"></a-sphere>
                <a-text id="clock-text" value="00:00" position="-2 1.8 -4.5" width="2" color="#fff" clock></a-text>

                <a-box id="couch-base" position="1.5 0.5 -1.5" width="2.5" height="1" depth="1" color="#5a3d2b" grabbable></a-box>
                <a-box id="couch-back" position="1.5 0.25 -1.5" width="2.5" height="0.5" depth="0.1" color="#5a3d2b" rotation="90 0 0"></a-box>
                <a-box id="couch-arm" position="1.5 0.25 -1.5" width="2.5" height="0.5" depth="0.1" color="#5a3d2b" rotation="-90 0 0"></a-box>

                <a-box id="light-switch" position="2.5 1.5 -5.9" width="0.1" height="0.2" depth="0.1" color="#333" light-switch></a-box>

                <a-box id="rain-switch" position="2.5 1.7 -5.9" width="0.1" height="0.2" depth="0.1" color="#00BFFF" rain-switch></a-box>

                <a-text id="thank-you-text" value="今日も一日お疲れさまでした" position="-1.5 1 -4" width="1" color="#fff" visible="false" align="center"></a-text>

                <a-plane position="0 -0.05 0" rotation="-90 0 0" width="100" height="100" color="#4a6741"></a-plane>
            </a-entity>
        </a-entity>
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
    </a-scene>
</body>
</html>